{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>Recommended Recipes For {{user.username}}</h1>
</div>

<div class="pantry-preview">
    <h3>My Pantry Preview</h3>

    <div class="pantry-preview-ingredients">
        {% if ingredients %}
        <table class="pantry-preview-table">
            <thead>
                <tr>
                    <th>Ingredient</th>
                    <th>Quantity</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for ingredient in ingredients %}
                <tr>
                    <td><strong>{{ ingredient.name }}</strong></td>
                    <td>{{ ingredient.quantity if ingredient.quantity else '-' }}</td>
                    <td>{{ ingredient.notes if ingredient.notes else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>You don't have any ingredients saved yet. Go to My Pantry to start adding!</p>
        {% endif %}
    </div>
</div>
<div class="recommendation-results">
    <h3>Recommended Recipes</h3>

    <!-- Display saved recipes from Flask -->
    <div id="recommendation-results">
        {% if recipes %}
            {% for r in recipes %}
                <div class="recipe-card">
                    <h4>{{ r.name }}</h4>
                    <img src="{{ r.image }}" alt="{{ r.name }}" width="120">
                    <p><strong>Matched ingredients:</strong> {{ r.matched_ingredients }}</p>
                    <p><strong>Missing ingredients:</strong>
                        {% if r.missing_ingredients %}{{ r.missing_ingredients | join(', ') }}{% else %}None{% endif %}
                    </p>
                    {% if r.dietary_tags %}
                        <p><strong>Dietary Tags:</strong> {{ r.dietary_tags | join(', ') }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>No recipes found for your pantry.</p>
        {% endif %}
    </div>

    <!-- Recommendation Button -->
    <button id="get-recommendations-btn" class="btn btn-success">
        Get New Recommendations
    </button>
</div>

<script>
    const ingredientNames = JSON.parse('{{ ingredients | map(attribute="name") | list | tojson | safe }}');
    const suggestionUrl = "{{ suggestion_api_url }}";

    document.getElementById('get-recommendations-btn').addEventListener('click', async () => {
        const payload = {
            ingredients: ingredientNames,
            top_n: 5,
            dietary: []
        };

        try {
            const response = await fetch(suggestionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const recipes = await response.json();

            const container = document.getElementById('recommendation-results');
            if (recipes.length === 0) {
                container.innerHTML = "<p>No recipes found for your pantry.</p>";
            } else {
                container.innerHTML = recipes.map(r => `
                    <div class="recipe-card">
                        <h4>${r.name}</h4>
                        <img src="${r.image}" alt="${r.name}" width="120">
                        <p><strong>Matched ingredients:</strong> ${r.matched_ingredients}</p>
                        <p><strong>Missing ingredients:</strong> ${r.missing_ingredients.length > 0
                            ? r.missing_ingredients.join(', ')
                            : 'None'}</p>
                        ${r.dietary_tags.length > 0
                            ? `<p><strong>Dietary Tags:</strong> ${r.dietary_tags.join(', ')}</p>`
                            : ''}
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error("Error fetching recipes:", err);
        }
    });
</script>
{% endblock %}
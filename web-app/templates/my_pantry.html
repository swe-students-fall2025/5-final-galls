{% extends "base.html" %}

{% block content %}
<div class="page-header">
  <h1>My Pantry</h1>
  <div class="pantry-header-actions">
    <a href="{{ url_for('add_ingredient') }}" class="btn btn-primary">+ Add Ingredient</a>
  </div>
</div>

{% if ingredients %}
<table class="pantry-table">
  <thead>
    <tr>
      <th>Ingredient</th>
      <th>Quantity</th>
      <th>Notes</th>
      <th class="actions-col">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for ingredient in ingredients %}
    <tr>
      <td>{{ ingredient.name }}</td>
      <td>{{ ingredient.quantity if ingredient.quantity else '-' }}</td>
      <td>{{ ingredient.notes if ingredient.notes else '-' }}</td>
      <td class="actions-col">
        <a href="{{ url_for('edit_ingredient', ingredient_id=ingredient._id) }}" class="btn btn-small">
          Edit
        </a>

        <form action="{{ url_for('delete_ingredient', ingredient_id=ingredient._id) }}" method="post"
          style="display:inline;">
          <button type="submit" class="btn btn-small btn-danger">
            Delete
          </button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Recommendation Button -->
<div class = "recommendation-results">
  <h3>Get Recipe Recommendations</h3>
  <button id = "get-recommendations-btn" class="btn btn-success">
    Get Recommendations
  </button>
  <div id = "recommendations-result"></div>
</div>
<script>
  // Prepare ingredient names from Flask
  const ingredientNames = JSON.parse('{{ ingredients | map(attribute="name") | list | tojson | safe }}');
  const suggestionUrl = "{{ suggestion_api_url }}";

  document.getElementById('get-recommendations-btn').addEventListener('click', async () => {
    const payload = {
      ingredients: ingredientNames,
      top_n: 5,
      dietary: []
    };

    try {
      const response = await fetch('http://localhost:8000/recommendations', {  // FastAPI URL
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const recipes = await response.json();

      // Render results
      const container = document.getElementById('recommendation-results');
      if (recipes.length === 0) {
        container.innerHTML = "<p>No recipes found for your pantry.</p>";
      } else {
        container.innerHTML = recipes.map(r => `
          <div class="recipe-card">
            <h4>${r.name}</h4>
            <img src="${r.image}" alt="${r.name}" width="100">
            <p>Matched ingredients: ${r.matched_ingredients}</p>
            <p>Missing ingredients: ${r.missing_ingredients.join(', ')}</p>
          </div>
        `).join('');
      }
    } catch (err) {
      console.error("Error fetching recipes:", err);
    }
  });
</script>
<!-- Empty State -->
{% else %}
<p class="empty-state">
  You don't have any ingredients saved yet.
  Click <strong>“Add Ingredient”</strong> to start building your pantry.
</p>
{% endif %}
{% endblock %}